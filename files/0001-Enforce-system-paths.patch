From fc34b87afe838ed83d3710e46bce2f1af8eb83ba Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@stroblindustries.com>
Date: Mon, 12 Feb 2018 20:34:23 +0200
Subject: [PATCH 1/1] Enforce system paths. Fixed Makefile. Fixed desktop
 files.

---
 Makefile                                | 12 ++----------
 guake/data/guake-prefs.template.desktop |  7 +------
 guake/data/guake.template.desktop       |  1 -
 guake/globals.py                        |  6 +++---
 4 files changed, 6 insertions(+), 20 deletions(-)

diff --git a/Makefile b/Makefile
index b271d30..e5958cb 100644
--- a/Makefile
+++ b/Makefile
@@ -3,7 +3,7 @@
 PYTHON_INTERPRETER=python3
 MODULE:=guake
 INSTALL_ROOT:=/
-PREFIX:=$(INSTALL_ROOT)usr/local
+PREFIX:=$(INSTALL_ROOT)usr
 DIST_PACKAGE:=$$($(PYTHON_INTERPRETER) -c "import site; import os; print(os.path.basename(site.getsitepackages()[0]))")
 OLD_PREFIX:=$(INSTALL_ROOT)usr
 SLUG:=fragment_name
@@ -11,7 +11,7 @@ SLUG:=fragment_name
 default: prepare-install
 	# 'make' target, so users can install guake without need to install the 'dev' dependencies
 
-prepare-install: generate-desktop generate-mo compile-glib-schemas
+prepare-install: generate-desktop generate-mo
 
 reset:
 	dconf reset -f /apps/guake/
@@ -40,8 +40,6 @@ install-system: install-schemas install-locale
 	@echo "Please prefer you application package manager (apt, yum, ...)"
 	@pip3 install -r requirements.txt
 	@$(PYTHON_INTERPRETER) setup.py install --root "$(INSTALL_ROOT)" --optimize=1
-	@glib-compile-schemas $(PREFIX)/lib/python$(shell $(PYTHON_INTERPRETER) -c "import sys; v = sys.version_info; print('{}.{}'.format(v.major, v.minor))")/$(DIST_PACKAGE)/guake/data/
-	@update-desktop-database || echo "Could not run update-desktop-database, are you root?"
 	@rm -rfv build *.egg-info
 
 install-locale:
@@ -62,7 +60,6 @@ install-schemas:
 	install -Dm644 "guake/data/guake-prefs.desktop" "$(PREFIX)/share/applications/guake-prefs.desktop"
 	install -Dm644 "guake/data/pixmaps/guake.png" "$(PREFIX)/share/pixmaps/guake.png"
 	install -Dm644 "guake/data/org.guake.gschema.xml" "$(PREFIX)/share/glib-2.0/schemas/org.guake.gschema.xml"
-	glib-compile-schemas $(PREFIX)/share/glib-2.0/schemas/
 
 
 uninstall-system: uninstall-schemas
@@ -78,7 +75,6 @@ uninstall-schemas: uninstall-old-schemas
 	rm -f "$(PREFIX)/share/pixmaps/guake.png"
 	rm -f "$(PREFIX)/share/glib-2.0/schemas/org.guake.gschema.xml"
 	rm -f  $(PREFIX)/lib/python$(shell $(PYTHON_INTERPRETER) -c "import sys; v = sys.version_info; print('{}.{}'.format(v.major, v.minor))")/$(DIST_PACKAGE)/guake/data/schema.guake.gschema.xml
-	[ -d $(PREFIX)/share/glib-2.0/schemas/ ] && glib-compile-schemas $(PREFIX)/share/glib-2.0/schemas/ || true
 
 uninstall-old-schemas:
 	@rm -f "$(OLD_PREFIX)/share/applications/guake.desktop"
@@ -87,10 +83,6 @@ uninstall-old-schemas:
 	@rm -f "$(OLD_PREFIX)/share/glib-2.0/schemas/org.guake.gschema.xml"
 	@rm -f "$(OLD_PREFIX)/share/glib-2.0/schemas/schema.guake.gschema.xml"
 	@rm -f $(OLD_PREFIX)/lib/python$(shell $(PYTHON_INTERPRETER) -c "import sys; v = sys.version_info; print('{}.{}'.format(v.major, v.minor))")/$(DIST_PACKAGE)/guake/data/schema.guake.gschema.xml
-	@glib-compile-schemas $(OLD_PREFIX)/share/glib-2.0/schemas/
-
-compile-glib-schemas: clean-schemas
-	glib-compile-schemas --strict guake/data/
 
 clean-schemas:
 	rm -f guake/data/gschemas.compiled
diff --git a/guake/data/guake-prefs.template.desktop b/guake/data/guake-prefs.template.desktop
index 03c7e2d..47cb367 100644
--- a/guake/data/guake-prefs.template.desktop
+++ b/guake/data/guake-prefs.template.desktop
@@ -1,13 +1,8 @@
 [Desktop Entry]
 Name=Guake Preferences
 Comment=Configure your Guake sessions
-TryExec=guake -p
 Exec=guake -p
 Icon=guake
 Type=Application
+Categories=GNOME;GTK;System;Utility;TerminalEmulator;
 StartupNotify=true
-Categories=GTK;GNOME;Settings;X-GNOME-PersonalSettings;
-OnlyShowIn=GNOME;
-X-GNOME-Settings-Panel=guake
-X-Desktop-File-Install-Version=0.15
-Keywords=Terminal;Utility;
diff --git a/guake/data/guake.template.desktop b/guake/data/guake.template.desktop
index f8c5250..f0590c7 100644
--- a/guake/data/guake.template.desktop
+++ b/guake/data/guake.template.desktop
@@ -7,4 +7,3 @@ Icon=guake
 Type=Application
 Categories=GNOME;GTK;System;Utility;TerminalEmulator;
 StartupNotify=true
-X-Desktop-File-Install-Version=0.22
diff --git a/guake/globals.py b/guake/globals.py
index 5dcd18f..fefc75e 100644
--- a/guake/globals.py
+++ b/guake/globals.py
@@ -51,9 +51,9 @@ NAME = 'guake'
 DATADIR = os.environ.get("GUAKE_DATA_DIR")
 
 SRC_DIR = os.path.dirname(os.path.realpath(__file__))
-IMAGE_DIR = os.path.join(SRC_DIR, 'data/pixmaps')
-GLADE_DIR = os.path.join(SRC_DIR, 'data')
-SCHEMA_DIR = os.path.join(SRC_DIR, 'data')
+IMAGE_DIR = "/usr/share/pixmaps/guake"
+GLADE_DIR = "/usr/share/guake"
+SCHEMA_DIR = "/usr/share/glib-2.0/schemas"
 LOCALE_DIR = "/usr/share/locale"
 
 ALIGN_CENTER, ALIGN_LEFT, ALIGN_RIGHT = range(3)
-- 
2.16.1

